% luatexko.sty
%
% Copyright (c) 2013-2014 Dohyun Kim  <nomos at ktug org>
%
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3c
% of this license or (at your option) any later version.
% The latest version of this license is in
%   http://www.latex-project.org/lppl.txt
% and version 1.3c or later is part of all distributions of LaTeX
% version 2006/05/20 or later.

\ifx\luatexkocatcodeofatchar\undefined\else
  \expandafter\endinput\fi % no multiple loading
\ifx\ProvidesPackage\relax \let\ProvidesPackage\undefined \fi
\ifx\ProvidesPackage\undefined % plain tex
  \edef\luatexkocatcodeofatchar{\catcode`@=\the\catcode`@}
  \input luatexko-core.sty
  %\hangulfont{name:NanumGothic:interlatincjk=0.125em} at 10pt
  %\setmathhangulfont{NanumGothic}
  \luatexkocatcodeofatchar
  \expandafter\endinput
\fi

\ProvidesPackage{luatexko}[2014/04/17 v1.5 Typesetting Korean with LuaLaTeX]

%% package options
\newif\if@hangul
\newif\if@hanja
\newif\if@unfonts
\newif\if@luatexko@loadfontspec\@luatexko@loadfontspectrue
\DeclareOption{hangul}{\@hangultrue}
\DeclareOption{hanja}{\@hangultrue\@hanjatrue}
\DeclareOption{unfonts}{\@unfontstrue}
\DeclareOption{nofontspec}{\@luatexko@loadfontspecfalse}
\ProcessOptions\relax

\if@luatexko@loadfontspec
  %% euenc redefines \f@size by \DeclareErrorFont. sigh
  \let\luatexko@f@size\f@size
  \RequirePackage{fontspec}
  \let\f@size\luatexko@f@size
\fi

\RequirePackage{luatexko-core}

\if@luatexko@loadfontspec
  %% fontspec Korean options
  \ExplSyntaxOn

  \DeclareDocumentCommand \newhangulfontfeature {mmmm}
    {
      \fontspec_define_font_feature:n {#1}
      \keys_define:nn {fontspec}
        {
          #1 .default:n = {#3} ,
          #1 / unknown .code:n = {
            \fontspec_update_fontid:n  {#2:##1}
            \fontspec_update_featstr:n {#2=##1}#4
          }
        }
    }

  \fontspec_define_font_feature:n {YetHangul}
  \keys_define:nn {fontspec}
    {
      YetHangul .default:n = {On} ,
      YetHangul / On .code:n = {
        \fontspec_update_fontid:n  {yethangul:on}
        \fontspec_update_featstr:n {script=hang;+ccmp;+ljmo;+vjmo;+tjmo}
      } ,
      YetHangul / Off .code:n = {
        \fontspec_update_fontid:n  {yethangul:off}
        \fontspec_update_featstr:n {-ljmo;-vjmo;-tjmo}
      }
    }

  \ExplSyntaxOff

  \newhangulfontfeature{InterHangul}{interhangul}{0}{}
  \newhangulfontfeature{InterLatinCJK}{interlatincjk}{0}{}
  \newhangulfontfeature{PunctRaise}{punctraise}{0}{}
  \newhangulfontfeature{CharRaise}{charraise}{0}{}
  \newhangulfontfeature{Protrusion}{protrusion}{default}{\aftergroup\pdfprotrudechars\aftergroup\tw@}
  \newhangulfontfeature{Expansion}{expansion}{default}{\aftergroup\pdfadjustspacing\aftergroup\tw@}

  %% macros for Korean fonts
  \def\luatexko@global@setfonts#1#2#3{%
    \expandafter\ifx\familydefault#3%
      \expandafter\let\csname #2@font\expandafter\endcsname
        \csname #1#2@font\endcsname
      \csname luatexko@#2@selectfont\endcsname
    \fi\ignorespaces
  }
  \protected\def\setmainhangulfont{%
    \@ifnextchar[\setmainhangulfont@{\setmainhangulfont@[]}}
  \def\setmainhangulfont@[#1]#2{%
    \newfontfamily\serifhangul@font[#1]{#2}%
    \luatexko@global@setfonts{serif}{hangul}\rmdefault}
  \protected\def\setmainhanjafont{%
    \@ifnextchar[\setmainhanjafont@{\setmainhanjafont@[]}}
  \def\setmainhanjafont@[#1]#2{%
    \newfontfamily\serifhanja@font[#1]{#2}%
    \luatexko@global@setfonts{serif}{hanja}\rmdefault}
  \protected\def\setmainfallbackfont{%
    \@ifnextchar[\setmainfallbackfont@{\setmainfallbackfont@[]}}
  \def\setmainfallbackfont@[#1]#2{%
    \newfontfamily\seriffallback@font[#1]{#2}%
    \luatexko@global@setfonts{serif}{fallback}\rmdefault}
  \protected\def\setsanshangulfont{%
    \@ifnextchar[\setsanshangulfont@{\setsanshangulfont@[]}}
  \def\setsanshangulfont@[#1]#2{%
    \newfontfamily\sanshangul@font[#1]{#2}%
    \luatexko@global@setfonts{sans}{hangul}\sfdefault}
  \protected\def\setsanshanjafont{%
    \@ifnextchar[\setsanshanjafont@{\setsanshanjafont@[]}}
  \def\setsanshanjafont@[#1]#2{%
    \newfontfamily\sanshanja@font[#1]{#2}%
    \luatexko@global@setfonts{sans}{hanja}\sfdefault}
  \protected\def\setsansfallbackfont{%
    \@ifnextchar[\setsansfallbackfont@{\setsansfallbackfont@[]}}
  \def\setsansfallbackfont@[#1]#2{%
    \newfontfamily\sansfallback@font[#1]{#2}%
    \luatexko@global@setfonts{sans}{fallback}\sfdefault}
  \protected\def\setmonohangulfont{%
    \@ifnextchar[\setmonohangulfont@{\setmonohangulfont@[]}}
  \def\setmonohangulfont@[#1]#2{%
    \newfontfamily\monohangul@font[#1]{#2}%
    \luatexko@global@setfonts{mono}{hangul}\ttdefault}
  \protected\def\setmonohanjafont{%
    \@ifnextchar[\setmonohanjafont@{\setmonohanjafont@[]}}
  \def\setmonohanjafont@[#1]#2{%
    \newfontfamily\monohanja@font[#1]{#2}%
    \luatexko@global@setfonts{mono}{hanja}\ttdefault}
  \protected\def\setmonofallbackfont{%
    \@ifnextchar[\setmonofallbackfont@{\setmonofallbackfont@[]}}
  \def\setmonofallbackfont@[#1]#2{%
    \newfontfamily\monofallback@font[#1]{#2}%
    \luatexko@global@setfonts{mono}{fallback}\ttdefault}

  \protected\def\newhangulfontfamily#1{%
    \protected\def#1{\expandafter\let\expandafter\hangul@font
    \csname luatexko@\string#1\endcsname
    \luatexko@hangul@selectfont}\expandafter\newfontfamily
    \csname luatexko@\string#1\endcsname}
  \protected\def\newhanjafontfamily#1{%
    \protected\def#1{\expandafter\let\expandafter\hanja@font
    \csname luatexko@\string#1\endcsname
    \luatexko@hanja@selectfont}\expandafter\newfontfamily
    \csname luatexko@\string#1\endcsname}
  \protected\def\newfallbackfontfamily#1{%
    \protected\def#1{\expandafter\let\expandafter\fallback@font
    \csname luatexko@\string#1\endcsname
    \luatexko@fallback@selectfont}\expandafter\newfontfamily
    \csname luatexko@\string#1\endcsname}

  \protected\def\newhangulfontface#1{%
    \protected\def#1{\expandafter\let\expandafter\hangul@font
    \csname luatexko@\string#1\endcsname
    \luatexko@hangul@selectfont}\expandafter\newfontface
    \csname luatexko@\string#1\endcsname}
  \protected\def\newhanjafontface#1{%
    \protected\def#1{\expandafter\let\expandafter\hanja@font
    \csname luatexko@\string#1\endcsname
    \luatexko@hanja@selectfont}\expandafter\newfontface
    \csname luatexko@\string#1\endcsname}
  \protected\def\newfallbackfontface#1{%
    \protected\def#1{\expandafter\let\expandafter\fallback@font
    \csname luatexko@\string#1\endcsname
    \luatexko@fallback@selectfont}\expandafter\newfontface
    \csname luatexko@\string#1\endcsname}

  \protected\def\hangulfontspec{%
    \@ifnextchar[\hangulfontspec@{\hangulfontspec@[]}}
  \def\hangulfontspec@[#1]#2{%
    \newfontfamily\hangul@font[#1]{#2}%
    \luatexko@hangul@selectfont\ignorespaces}
  \let\adhochangulfont\hangulfontspec
  \protected\def\hanjafontspec{%
    \@ifnextchar[\hanjafontspec@{\hanjafontspec@[]}}
  \def\hanjafontspec@[#1]#2{%
    \newfontfamily\hanja@font[#1]{#2}%
    \luatexko@hanja@selectfont\ignorespaces}
  \let\adhochanjafont\hanjafontspec
  \protected\def\fallbackfontspec{%
    \@ifnextchar[\fallbackfontspec@{\fallbackfontspec@[]}}
  \def\fallbackfontspec@[#1]#2{%
    \newfontfamily\fallback@font[#1]{#2}%
    \luatexko@fallback@selectfont\ignorespaces}
  \let\adhocfallbackfont\fallbackfontspec

  % add{hangul/hanja}fontfeature
  \def\luatexko@@add@fontfeature#1#2{%
    \begingroup
    \ifcsname #1@font\endcsname\csname #1@font\endcsname\fi
    \addfontfeature{#2}%
    \edef\x{\endgroup
      \noexpand\expandafter\def\noexpand\csname #1@font\endcsname
      {\noexpand\fontfamily{\f@family}\noexpand\selectfont}}\x
    \csname luatexko@#1@selectfont\endcsname\ignorespaces
  }
  \protected\def\addhangulfontfeature{\luatexko@@add@fontfeature{hangul}}
  \let\addhangulfontfeatures\addhangulfontfeature
  \protected\def\addhanjafontfeature{\luatexko@@add@fontfeature{hanja}}
  \let\addhanjafontfeatures\addhanjafontfeature
  \protected\def\addfallbackfontfeature{\luatexko@@add@fontfeature{fallback}}
  \let\addfallbackfontfeatures\addfallbackfontfeature
\fi

\RequirePackage{everysel}
\EverySelectfont{%
  \luatexko@hangul@selectfont
  \luatexko@hanja@selectfont
  \luatexko@fallback@selectfont
}

% serif    : finemathattr = 2
% sans     : finemathattr = 1
% tt       : finemathattr = 0
% verbatim : finemathattr = nil
\def\luatexko@serif@fonts{%
  \let\hangul@font\serifhangul@font
  \let\hanja@font\serifhanja@font
  \let\fallback@font\seriffallback@font
  \finemathattr\tw@
}
\def\luatexko@sans@fonts{%
  \let\hangul@font\sanshangul@font
  \let\hanja@font\sanshanja@font
  \let\fallback@font\sansfallback@font
  \finemathattr\@ne
}
\def\luatexko@mono@fonts{%
  \let\hangul@font\monohangul@font
  \let\hanja@font\monohanja@font
  \let\fallback@font\monofallback@font
  \finemathattr\z@
}

\protected\edef\rmfamily{%
  \unexpanded{\luatexko@serif@fonts}\unexpanded\expandafter{\rmfamily}}
\protected\edef\sffamily{%
  \unexpanded{\luatexko@sans@fonts}\unexpanded\expandafter{\sffamily}}
\protected\edef\ttfamily{%
  \unexpanded{\luatexko@mono@fonts}\unexpanded\expandafter{\ttfamily}}
\edef\verbatim@font{\unexpanded\expandafter{\verbatim@font
  \unsetluatexattribute\finemathattr}}

% don't forget to redefine \normalfont
\expandafter\ifx\familydefault\rmdefault
  \protected\edef\normalfont{%
    \unexpanded{\luatexko@serif@fonts}\unexpanded\expandafter{\normalfont}}
  \finemathattr\tw@
\else\expandafter\ifx\familydefault\sfdefault
  \protected\edef\normalfont{%
    \unexpanded{\luatexko@sans@fonts}\unexpanded\expandafter{\normalfont}}
  \finemathattr\@ne
\else
  \protected\edef\normalfont{%
    \unexpanded{\luatexko@mono@fonts}\unexpanded\expandafter{\normalfont}}
  \finemathattr\z@
\fi\fi
\let\reset@font\normalfont

\if@unfonts\if@luatexko@loadfontspec
  \setmainhangulfont[
    InterHangul=-0.04em,
    InterLatinCJK=0.125em,
    PunctRaise=-0.125em,
    Ligatures=TeX,
    SlantedFont=*, SlantedFeatures={FakeSlant=0.2},
    ItalicFont=*,  ItalicFeatures={FakeSlant=0.2},
    BoldSlantedFont=*Bold, BoldSlantedFeatures={FakeSlant=0.2},
    BoldItalicFont=*Bold,  BoldItalicFeatures={FakeSlant=0.2},
  ]{UnBatang}
  \setsanshangulfont[
    InterLatinCJK=0.125em,
    PunctRaise=-0.125em,
    Ligatures=TeX,
    SlantedFont=*, SlantedFeatures={FakeSlant=0.2},
    ItalicFont=*,  ItalicFeatures={FakeSlant=0.2},
    BoldSlantedFont=*Bold, BoldSlantedFeatures={FakeSlant=0.2},
    BoldItalicFont=*Bold,  BoldItalicFeatures={FakeSlant=0.2},
  ]{UnDotum}
  \setmonohangulfont[
    SlantedFont=*, SlantedFeatures={FakeSlant=0.2},
    ItalicFont=*,  ItalicFeatures={FakeSlant=0.2},
    BoldSlantedFont=*Bold, BoldSlantedFeatures={FakeSlant=0.2},
    BoldItalicFont=*Bold,  BoldItalicFeatures={FakeSlant=0.2},
  ]{UnDotum}
\fi\fi

\AtBeginDocument{
\unless\ifdefined\serifhangul@font\let\serifhangul@font\sanshangul@font\fi
\unless\ifdefined\sanshangul@font \let\sanshangul@font\serifhangul@font\fi
\unless\ifdefined\monohangul@font \let\monohangul@font\sanshangul@font \fi
\unless\ifdefined\serifhangul@font\unless\ifdefined\sanshangul@font
  \hangulpunctuations=0 % nanumtype1
\fi\fi
% for hyperref
\@ifpackageloaded{hyperref}{\pdfstringdefDisableCommands{%
  \let\dotemph\@firstofone
  \let\ruby\@firstoftwo
  \let\uline\@firstofone
  \let\sout\@firstofone
  \let\uuline\@firstofone
  \let\xout\@firstofone
  \let\uwave\@firstofone
  \let\dashuline\@firstofone
  \let\dotuline\@firstofone
  \let\actualtext\@firstofone
  \let\inhibitglue\empty
  \def\는{는}%
  \def\은{은}%
  \def\을{을}%
  \def\를{를}%
  \def\와{와}%
  \def\과{과}%
  \def\가{가}%
  \def\이{이}%
  \def\라{라}%
  \def\으{으}%
  \def\로{로}%
  }}{}
}

\if@luatexko@loadfontspec
  %% hangul in math --- latex
  \protected\def\setmathhangulfont{%
    \@ifnextchar[{\setmathhangul@font@}{\setmathhangul@font@[]}}
  \def\setmathhangul@font@[#1]#2{%
    \zf@fontspec{#1}{#2}\xdef\luatexko@math@hangul@family{\zf@family}}
  \AtBeginDocument{
    \begingroup
      \unless\ifdefined\luatexko@math@hangul@family
        \ifdefined\hangul@font \hangul@font \fi
        \xdef\luatexko@math@hangul@family{\f@family}%
      \fi
    \endgroup
    \DeclareSymbolFont{mathhangul}%
      \zf@enc\luatexko@math@hangul@family\mddefault\updefault
    \ifcsname\zf@enc/\luatexko@math@hangul@family/\bfdefault/\updefault\endcsname
      \SetSymbolFont{mathhangul}{bold}%
        \zf@enc\luatexko@math@hangul@family\bfdefault\updefault
    \fi
    \setmathhangulblock{AC00}{D7A3}
  }
\fi

\RequirePackage{kolabels-utf}
\if@hangul
  \AtBeginDocument{\RequirePackage{konames-utf}}
  \linespread{1.3888}
  \footnotesep=1.3888\footnotesep
  \skip\footins=1.3888\skip\footins plus6pt minus3pt
  \hangulpunctuations=1
  \frenchspacing
\fi

\endinput
